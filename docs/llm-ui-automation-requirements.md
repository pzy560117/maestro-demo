## 需求文档：LLM 驱动的手机端 UI 自动化定位系统

### 1. 项目背景
- 当前 UI 自动化脚本维护成本高，定位信息易受动态 ID、结构变化影响。
- 系统主要在公司内部由个人使用，场景集中在自有测试需求，聚焦 Android 原生 APP 的界面遍历。
- 希望利用 Qwen3 多模态模型结合 MidSceneJS、ADB、Appium，实现自动遍历界面并生成稳定的定位信息。
- 目标是降低脚本编写与维护成本，提升 UI 回归覆盖率。

### 2. 建设目标
- 自动遍历移动应用主要界面，采集截图、DOM 树、可交互操作。
- 生成稳定、可回放的元素定位信息，并自动验证其有效性。
- 建立界面版本库，支持定位回溯、差异分析与回归告警。
- 提供可审计的 LLM 操作记录，确保安全可控。

### 3. 项目范围
- 聚焦公司内部 Android 原生 APP；如后续有新需求再评估 iOS 扩展可能性。
- 优先覆盖个人常用的 1~2 条关键业务流程，确保自用测试场景先行可用。
- 输出定位数据、遍历报告、告警通知；暂不直接生成自动化脚本（可作为长期规划）。

### 4. 术语说明
- **LLM**：大语言模型（统一采用 Qwen3 多模态版本）。
- **MidSceneJS**：用于图像理解和 DOM 辅助解析的 JS 库。
- **Traversal Orchestrator**：遍历指挥服务。
- **定位信息**：Automation ID、Resource-ID、XPath、图像模板等可供自动化脚本使用的定位手段。

### 5. 系统总体架构
- **指挥调度层**：Traversal Orchestrator、LLM Prompt 管理、动作安全白名单。
- **执行层**：Appium 控制器、ADB 工具集、MidSceneJS 适配器。
- **感知与对齐层**：DOM 抽取、视觉对比、定位融合、置信度评估。
- **数据与服务层**：由 TypeScript + NestJS 构建的后端服务，统一封装 Postgres（结构化数据）、MinIO/OSS（截图/附件）、消息队列（任务派发），并通过 OpenAPI/JSON Schema 暴露接口，便于大模型解析与调用。
- **前端展示层**：基于 TypeScript + React + TailwindCSS + shadcn/ui 的可视化后台，为人工复核与报告查阅提供界面。

### 6. 功能需求
#### 6.1 遍历管理
- 维护界面访问状态机（去重、深度限制、回退策略）。
- 支持人工配置黑名单路径、优先级队列。
- 记录操作序列，支持恢复与回放。

#### 6.2 LLM 指挥接口
- 提供标准化技能 API：`_list_actions`、`_navigate`、`_inspect_dom`、`_capture_screen`。
- Prompt 模板控制：包含目标描述、上下文、操作约束、异常处理指引。
- 调用日志化，保存思维链、输入输出，便于审计。

#### 6.3 元素感知与定位生成
- DOM 特征抽取：文本、Resource-ID、Content-Desc、Class、层级路径。
- MidSceneJS 解析截图，输出元素区域、视觉特征、文本识别结果。
- 生成候选定位（Automation ID、XPath、视觉模板等）。
- 动态属性识别与过滤（正则：时间戳、随机数、UUID）。
- 置信度计算（来源权重、可见性、与视觉匹配度）。
- 自动验证定位有效性（立即尝试定位并点击/高亮）。

#### 6.4 数据存储与版本管理
- 界面签名：基于截图 hash、主文案、元素结构生成唯一标识。
- 记录每次遍历结果：截图、DOM、操作序列、定位列表、验证状态。
- 界面 diff：比较不同版本界面差异，生成变化报告。
- 定位库 API：按界面签名查询最佳定位及历史记录。

#### 6.5 结果输出与告警
- 遍历完成后生成报告（覆盖界面数、失败率、低置信元素列表）。
- 可配置告警（如定位失效、界面异常）推送到飞书/企业微信/邮件。
- 可视化后台：展示界面缩略图、定位详情、置信度、历史版本。

### 7. 非功能需求
- **性能**：单设备遍历 30 分钟内完成 50+ 界面采集；定位生成延迟 <2 秒/元素。
- **可靠性**：系统可自动恢复异常（App 崩溃、连接断开）；遍历任务失败率 <5%。
- **扩展性**：支持多设备并发（水平扩展）；LLM 可替换（标准化接口）。
- **安全性**：LLM 调用需鉴权；敏感数据脱敏存储；操作日志全量留存。
- **可维护性**：模块化设计，提供单元测试 >70% 覆盖率；文档完备。

### 8. 数据模型（核心要素）
- `Screens`：界面签名、应用版本、截图路径、DOM 哈希、生成时间。
- `Elements`：绑定 `Screen`，含定位策略、置信度、验证状态、截图区域。
- `Actions`：遍历操作、操作前后界面、是否成功、耗时。
- `LLMLogs`：模型请求、响应、使用 token、调用时间。
- `Alerts`：告警类型、触发条件、通知记录。

### 9. 对外接口
#### REST/WebSocket API
- `POST /tasks`：创建遍历任务（参数：APP 版本、设备 ID、覆盖范围）。
- `GET /tasks/{id}`：获取任务状态与报告。
- `GET /screens/{signature}`：获取界面及定位详情。
- `GET /alerts`：查询告警历史。

#### LLM Skill API（内部）
- `callAction(action, params)`：序列化为标准 JSON，传入执行层。

### 10. 核心流程
#### 初始化
- 解析需求 → 配置设备 → 注册 LLM Key → 加载 APP。

#### 遍历循环
1. Orchestrator 请求 LLM 获取下一步操作。
2. 执行层调用 Appium/ADB 完成动作，截屏并抓取 DOM。
3. MidSceneJS 对截图进行视觉解析，与 DOM 对齐。
4. 定位生成器输出候选定位，自动验证并写库。
5. Orchestrator 判断界面是否已访问，决定下一步。

#### 收尾
- 生成报告、触发告警、更新界面版本库。

### 11. 安全与合规
- 所有 Qwen3 多模态调用需通过企业代理网关，确保 API Key 不泄露。
- 存储敏感信息（账号、隐私数据）时需加密或脱敏。
- 操作日志保存 ≥180 天，满足审计要求。
- 支持白名单 APP/环境，防止误操作生产环境。

### 12. 运维与监控
- 运行监控：设备在线率、任务成功率、LLM 调用耗时。
- 日志指标：遍历异常、定位失败、告警次数。
- 自动恢复策略：设备断连 → 重连；App 崩溃 → 重启并回退一步。
- 灰度/版本控制：系统升级前先在沙箱环境验证。

### 13. 测试策略
- 单元测试：遍历状态机、定位生成算法、动态属性过滤。
- 集成测试：LLM 指挥 → 执行层全链路打通。
- 设备测试：不同分辨率、Android 版本、语言环境。
- 回归测试：界面 diff 告警、定位回放验证。
- 压力测试：并发任务、LLM 请求限流。

### 14. 里程碑计划（建议）
- **M1（第 2 周）**：基础架构搭建，Appium + ADB + MidSceneJS 集成打通。
- **M2（第 4 周）**：完成 Orchestrator 原型与 LLM 接口，覆盖 1 条核心流程。
- **M3（第 6 周）**：实现定位生成与自动验证，界面存档与 diff。
- **M4（第 8 周）**：可视化后台、告警体系、测试与优化。
- **M5（第 10 周）**：多设备并行、性能调优、上线试运行。

### 15. 风险与缓解
- **模型误操作**：通过动作白名单、回退机制、人工审查降低风险。
- **动态 UI 频繁变化**：加强视觉 + 文本特征组合定位，保持置信度评估。
- **MidSceneJS 兼容性**：需预先验证 GPU/驱动要求，必要时做容器封装。
- **设备稳定性**：准备模拟器与真机混合方案，定期刷新环境。
- **成本控制**：缓存 LLM 调用、对重复界面使用历史数据，减少 token 消耗。

### 16. 资源需求
- **人员**：以个人自用为主，主要由本人承担需求分析、研发与运维；必要时可争取后端/DevOps 支持（按需参与）。
- **硬件**：至少 1 台 Android 真机（与目标 APP 相同版本）、1 套 Android 模拟器环境；如需 MidSceneJS GPU 加速，可使用公司共享服务器。
- **软件**：Appium、ADB、MidSceneJS、Postgres、MinIO、Prometheus/Grafana、消息队列。
- **前端技术栈**：TypeScript、React、TailwindCSS、shadcn/ui。
- **后端技术栈**：TypeScript、NestJS、Prisma（或 TypeORM）、OpenAPI/JSON Schema 工具链。

### 17. 后续工作
- 完成详细技术设计文档（模块接口、数据结构、算法流程）。
- 制定标准 Prompt 模板，并进行安全审核。
- 准备试点应用名单，收集关键业务流程描述与账号。
- 建立验收标准：覆盖率、定位成功率、告警准确率等指标。

---

该文档为需求阶段基线，后续迭代需同步更新并走变更评审流程。

