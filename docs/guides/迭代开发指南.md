# LLM 驱动的手机端 UI 自动化定位系统 — 迭代开发指南

> 依据《PRD需求.md》，结合界面/原型设计，将功能原子化拆分，形成可执行、可验收的迭代 backlog。优先级按 Must / Should / Could 规划迭代顺序。

## 1. 迭代规划概览

| 迭代 | 目标 | 涵盖功能 | 预期交付 |
| --- | --- | --- | --- |
| Iteration 0 | 基础设施搭建 | 环境准备、设备接入、安全基线 | Appium + MidSceneJS PoC、GPU 节点、流水线 |
| Iteration 1 | 遍历指挥调度核心 | FR-01/02/03/04/05 | 可运行的 Orchestrator + 初版日志 |
| Iteration 2 | 定位生成与验证 | FR-06/07/08/09 | 元素定位链接路、验证回放、数据入库 |
| Iteration 3 | 界面资产与告警 | FR-10/12/13 | 界面版本库、差异报告、告警通路、审计日志 |
| Iteration 4 | 前端后台与 API | FR-11/14 | Dashboard、任务/界面/告警管理、对外 API |
| Iteration 5 | 性能与多设备扩展 | FR-15 + 非功能 | 多设备调度、性能调优、监控告警完善 |

以下按功能原子单元列出设计。

## 2. 原子功能清单

### 功能 A：应用与设备注册（Iteration 0）

- **功能名称**：设备与应用接入管理
- **功能描述**：允许运维录入可用 Android 设备、关联企业内部应用版本，为后续任务调度提供基础数据。
- **用户故事**：
  - 作为运维，我需要登记测试设备和应用版本，以便 Orchestrator 可以挑选正确的资源执行遍历。
- **输入**：
  - 设备：序列号（必填）、型号、Android 版本、类型（真机/模拟器）、标签、MDM 状态
  - 应用版本：应用名称、包名、版本号、APK 哈希、发布说明
- **处理**：
  - 校验设备是否在线（ADB ping），不在线提示“设备离线，无法登记”
  - 应用版本校验包名唯一性，重复提示“版本已存在”
  - 成功后写入 `devices`、`apps`、`app_versions`
- **输出**：
  - 成功：返回资源 ID，并在仪表盘显示可用资源数量
  - 失败：在表单顶部显示错误原因
- **验收标准**：
  1. 录入重复设备序列号时提示“设备已存在”，记录未更新
  2. 录入新设备、ADB 校验通过后，`devices` 表存在记录且状态为 `AVAILABLE`
  3. 创建新应用版本后，任务创建页面可下拉选择该版本
  4. 设备状态离线时，系统自动标记为 `OFFLINE`，后台弹出告警提示
- **BDD**：
```gherkin
功能: 设备登记
  场景: 成功登记可用设备
    假如 运维在设备登记表单输入 "emulator-5554"、"Pixel 6"、"Android 13"
    当 点击保存按钮
    那么 系统提示 "设备登记成功"
    且 设备列表中显示 "emulator-5554" 状态为 "AVAILABLE"
```
- **边界**：
  - 序列号长度 1-64 字符
  - 标签数量 ≤ 10 个
  - 应用版本号遵循 `x.y.z` 或文本，长度 ≤ 32

### 功能 B：遍历任务创建（FR-01, Iteration 1）

- **功能名称**：遍历任务创建与管理
- **描述**：用户在后台创建遍历任务，配置应用版本、设备、覆盖配置。
- **用户故事**：
  - 作为 QA，我希望根据指定 app 版本和设备创建遍历任务，以便自动采集界面定位信息。
- **输入**：
  - 任务名称（必填，≤50 字符）
  - 应用版本（必选）
  - 设备（至少 1 台，可多选）
  - 覆盖策略（全量/核心流程/自定义）
  - 黑名单路径列表、优先级（1-5）
- **处理**：
  - 校验选中设备状态（`AVAILABLE`），否则提示“设备不可用”
  - 保存任务配置，生成初始状态 `QUEUED`
- **输出**：
  - 成功：任务详情页，显示“排队中”状态
  - 失败：表单顶部错误信息，字段标红
- **验收标准**：
  1. 未选择设备提交时，提示“请选择至少一台设备”
  2. 同一个设备若已有运行任务，提示“设备正忙”
  3. 创建成功后，可在任务列表看到新任务，状态 `QUEUED`
  4. API `POST /tasks` 返回任务 ID，并在 DB `tasks` 表有记录
- **BDD**：
```gherkin
功能: 创建遍历任务
  场景: 指定单台设备创建成功
    当 用户选择应用版本 "审批中心 6.3.1"
    且 选择设备 "Pixel6-01"
    且 设置覆盖策略 "核心流程"
    当 点击创建任务
    那么 任务列表出现名称为 "审批核心流程遍历" 的任务
    且 状态显示为 "QUEUED"
```
- **边界**：
  - 一次最多选择 5 台设备（避免资源抢占）
  - 黑名单路径数量 ≤ 50

### 功能 C：Orchestrator 状态机（FR-02, Iteration 1）

- **功能名称**：遍历调度状态机执行
- **描述**：根据任务配置，调度器驱动 LLM 获取动作、执行、校验。
- **用户故事**：
  - 作为系统，我需要自动遍历界面、避免重复，遇到异常能自动回退，以保证遍历持续进行。
- **输入**：
  - 任务配置、动作白名单、已访问界面图
- **处理**：
  - 状态流转：Idle → Bootstrapping → Traversing → Inspecting → Executing → Verifying → Traversing/Recovering → Terminated
  - 队列优先级调度，多级队列出队（primary/fallback/revisit）
- **输出**：
  - 动作执行日志、界面签名、失败重试记录
- **验收标准**：
  1. 当界面重复时，VisitedGraph 阻止重复动作，队列降级
  2. 执行失败时调用回退策略（UI Undo → App Restart），记录在 `task_run_events`
  3. 任务完成后状态变为 `SUCCEEDED`，覆盖界面数≥配置要求
  4. 任务失败时 `failure_reason` 包含具体动作/错误码
- **BDD**：
```gherkin
功能: 遍历调度状态机
  场景: 动作执行失败触发回退
    当 调度器执行动作 "点击确认按钮"
    且 Appium 返回错误 "ElementNotFound"
    那么 系统记录事件 "执行失败"
    且 执行回退动作 "返回上一页"
    且 将当前界面加入 revisit 队列
```
- **边界**：
  - 最大重试次数 3 次
  - 同一界面遍历深度 ≤ 10 层

### 功能 D：LLM 指令生成与安全控制（FR-03/04, Iteration 1）

- **描述**：构建 Prompt 请求 Qwen3，多模态分析后输出动作，经过白名单校验。
- **输入**：
  - 截图摘要、DOM 节点、历史操作、动作白名单
- **处理**：
  - Prompt Builder 组装 system/user/context，调用 Qwen3-VL
  - 对响应进行 JSON Schema 校验
  - 校验动作是否在白名单，参数合法性（点击坐标、输入内容等）
  - 不符合策略则拒绝，返回 fallback
- **输出**：
  - 结构化动作计划、拒绝记录
- **验收标准**：
  1. Qwen3 返回非 JSON 格式时，系统记录错误并触发 fallback
  2. 非白名单动作被拦截，任务继续执行默认策略
  3. LLM 请求/响应存入 `llm_logs`，包含 tokens、latency
  4. 触发策略拒绝时，告警中心出现记录
- **BDD**：
```gherkin
功能: LLM 指令生成
  场景: 非白名单动作被拦截
    假如 LLM 返回动作 "卸载应用"
    当 安全校验执行
    那么 系统拒绝当前动作
    且 返回错误码 "POLICY_BLOCKED"
    且 任务继续使用 fallback 策略
```
- **边界**：
  - 每界面最多 5 次 LLM 请求
  - 单次 Prompt tokens ≤ 6k

### 功能 E：视觉解析与定位融合（FR-06/07, Iteration 2）

- **描述**：MidSceneJS 输出元素视觉特征，与 DOM 结合生成定位候选并计算置信度。
- **输入**：
  - 截图路径、DOM JSON、历史定位数据
- **处理**：
  - 调用 MidSceneJS `analyzeScreen`，获取 bbox、OCR
  - 与 DOM 特征合并，生成不同策略（ID、文本、视觉模板等）
  - 计算置信度并排序
- **输出**：
  - 定位候选集 (`locator_candidates`)，置信度、动态标记
- **验收标准**：
  1. 无 resourceId 的元素提供文本+视觉组合定位
  2. 动态属性（时间、UUID）被识别并标记 dynamic_flags
  3. 置信度低于 0.5 的定位进入 revisit 队列
  4. `elements`、`locator_candidates` 表记录完整
- **BDD**：
```gherkin
功能: 定位融合
  场景: 为文本按钮生成定位候选
    假如 截图中包含文本 "提交"
    当 执行定位融合
    那么 生成策略 "TEXT" 候选，值为 "提交"
    且 置信度大于 0.7
```
- **边界**：
  - 单屏最大检测元素数 200
  - 定位候选 per element ≤ 5 条

### 功能 F：自动验证与截图回放（FR-08, Iteration 2）

- **描述**：验证定位候选是否可点击/高亮，记录结果与截图。
- **处理**：
  - 按置信度顺序尝试定位
  - 调用 Appium 执行点击/高亮
  - 捕获前后截图，存储至 MinIO
  - 成功则标记，失败尝试下一候选
- **验收标准**：
  1. 验证通过的候选 `status=PASSED`，记录 `last_verified_at`
  2. 失败超限时产生告警，记录失败截图
  3. 回放界面可查看验证前后截图
- **BDD**：
```gherkin
功能: 自动验证
  场景: 定位验证失败触发告警
    当 系统尝试点击元素 "提交"
    且 三次尝试均失败
    那么 记录验证状态 "FAILED"
    且 触发告警 "LOCATOR_FAILURE"
```
- **边界**：
  - 每定位候选尝试次数 ≤ 3
  - 截图大小 < 500KB（WebP）

### 功能 G：界面签名与存档（FR-09, Iteration 2）

- **描述**：生成界面签名，存档截图、DOM、定位列表。
- **处理**：
  - 计算截图 hash、DOM hash、主文案生成 signature
  - 入库 `screens`、`elements`
  - 存储截图/DOM 到 MinIO
- **验收标准**：
  1. 同一界面多次访问生成相同签名
  2. 新界面存档后，可在界面库查看缩略图
  3. `screens` 表 `signature` 唯一

### 功能 H：界面差异分析（FR-10, Iteration 3）

- **描述**：对比不同版本界面，生成差异报告并告警。
- **输入**：
  - 基线界面签名、最新界面
- **处理**：
  - 分析新增/删除/修改元素，计算 diff summary
  - 生成报告写入 `screen_diffs`
  - 差异超阈值触发告警
- **验收标准**：
  1. 元素新增/移除准确记录
  2. 告警中心可查看差异详情
  3. 支持导出 diff 报告

### 功能 I：告警通知与确认流程（FR-12, Iteration 3）

- **描述**：根据告警类型推送通知，支持确认与处理记录。
- **处理**：
  - 告警触发 → 写入 `alerts`
  - 策略匹配 → 发送飞书/企业微信/邮件
  - 用户确认/指派 → 更新 `alerts`、`alert_notifications`
- **验收标准**：
  1. P1 告警 1 分钟内发出飞书消息
  2. 告警详情可查看通知记录
  3. 确认后状态变为 `ACKED`

### 功能 J：LLM 审计日志（FR-13, Iteration 3）

- **描述**：保存每次 LLM 请求/响应、思维链、token、错误码。
- **验收标准**：
  1. `llm_logs` 含 request/response JSON、tokens、latency
  2. 支持下载指定时间范围日志
  3. 日志保留 180 天

### 功能 K：前端后台仪表盘（FR-11, Iteration 4）

- **描述**：提供 Dashboard、任务、界面、告警管理页面。
- **验收标准**：
  1. 仪表盘展示覆盖率、定位成功率、告警趋势
  2. 任务详情页可播放回放、查看定位验证记录
  3. 界面库支持版本筛选、差异查看

### 功能 L：对外 API 与 WebSocket（FR-14, Iteration 4）

- **描述**：开放任务创建、状态查询、告警查询的 REST API，提供任务状态推送。
- **验收标准**：
  1. `POST /tasks` 返回 201 + 任务 ID
  2. `GET /tasks/{id}` 返回状态与覆盖指标
  3. WebSocket 推送任务状态变更

### 功能 M：多设备扩展与性能（FR-15 + 非功能, Iteration 5）

- **描述**：支持多设备并发、性能监控、异常自动恢复。
- **验收标准**：
  1. 支持同时执行 ≥3 台设备遍历
  2. 单设备 30 分钟覆盖 ≥50 界面
  3. Prometheus 展示关键指标，Grafana 仪表上线
  4. 自动恢复脚本成功率 ≥85%

## 3. 非功能需求落实

- **性能**：在 Iteration 5 引入压力测试用例，覆盖 LLM 调用限流、队列堆积告警
- **可靠性**：在 Orchestrator 功能中实现回退、重试、断电恢复，编写 Chaos 测试
- **安全性**：自 Iteration 1 起引入白名单/脱敏；Iteration 3 完成审计日志；Iteration 4 接入 SSO
- **可维护性**：
  - 单元测试覆盖率按迭代推进：Iter1 ≥40%，Iter3 ≥60%，上线前 ≥70%
  - 完成 README、接口文档、运维手册

## 4. 验收与发布流程

1. 每迭代结束进行 Demo + QA 验收，依据本指南列出的验收标准执行
2. 通过 CI 自动化测试（单元、集成）并出具测试报告
3. 上线前执行回归遍历，验证关键流程定位准确率 ≥90%
4. 运维签字确认监控/告警有效，记录上线变更单

## 5. 后续迭代可选项

- 引入更多视觉模型（如 Doubao/Gemini）做对比评估
- 扩展到 iOS 平台，与企业内部多语言版本联动
- 基于历史定位数据训练本地模型，提高置信度预测
- 建立脚本自动生成器，将定位成果转化为自动化脚本代码

